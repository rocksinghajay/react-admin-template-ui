'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _reactMove = require('react-move');

var _reactState = require('react-state');

var _Selectors = require('../utils/Selectors');

var _Selectors2 = _interopRequireDefault(_Selectors);

var _HyperResponsive = require('../utils/HyperResponsive');

var _HyperResponsive2 = _interopRequireDefault(_HyperResponsive);

var _Utils = require('../utils/Utils');

var _Utils2 = _interopRequireDefault(_Utils);

var _Rectangle = require('../primitives/Rectangle');

var _Rectangle2 = _interopRequireDefault(_Rectangle);

var _Voronoi = require('../components/Voronoi');

var _Voronoi2 = _interopRequireDefault(_Voronoi);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }
//


var Chart = function (_PureComponent) {
  _inherits(Chart, _PureComponent);

  function Chart() {
    _classCallCheck(this, Chart);

    var _this = _possibleConstructorReturn(this, (Chart.__proto__ || Object.getPrototypeOf(Chart)).call(this));

    _this.updateDataModel = _this.updateDataModel.bind(_this);
    _this.measure = _this.measure.bind(_this);
    _this.onMouseMove = _Utils2.default.throttle(_this.onMouseMove.bind(_this), 16);
    _this.onMouseLeave = _this.onMouseLeave.bind(_this);
    _this.onMouseDown = _this.onMouseDown.bind(_this);
    _this.onMouseUp = _this.onMouseUp.bind(_this);
    return _this;
  }

  _createClass(Chart, [{
    key: 'componentDidMount',
    value: function componentDidMount() {
      var _this2 = this;

      this.props.dispatch(function (state) {
        return _extends({}, state, {
          interaction: _this2.props.interaction
        });
      }, {
        type: 'interaction'
      });
      this.updateDataModel(this.props);
      this.componentDidUpdate(this.props);
    }
  }, {
    key: 'componentWillReceiveProps',
    value: function componentWillReceiveProps(nextProps) {
      // If anything related to the data model changes, update it
      if (nextProps.interaction !== this.props.interaction) {
        this.props.dispatch(function (state) {
          return _extends({}, state, {
            interaction: nextProps.interaction
          });
        }, {
          type: 'interaction'
        });
      }

      if (nextProps.data !== this.props.data || nextProps.width !== this.props.width || nextProps.height !== this.props.height || nextProps.getData !== this.props.getData || nextProps.getSeriesID !== this.props.getSeriesID || nextProps.getLabel !== this.props.getLabel || nextProps.getPrimary !== this.props.getPrimary || nextProps.getSecondary !== this.props.getSecondary || nextProps.getR !== this.props.getR) {
        this.updateDataModel(nextProps);
      }
    }
  }, {
    key: 'shouldComponentUpdate',
    value: function shouldComponentUpdate(nextProps) {
      if (nextProps.style !== this.props.style || nextProps.width !== this.props.width || nextProps.height !== this.props.height || nextProps.gridX !== this.props.gridX || nextProps.gridY !== this.props.gridY || nextProps.children !== this.props.children) {
        return true;
      }
      return false;
    }
  }, {
    key: 'componentDidUpdate',
    value: function componentDidUpdate(prevProps) {
      var _this3 = this;

      _Utils2.default.requestAnimationFrame(function () {
        return _this3.measure(prevProps);
      });
    }
  }, {
    key: 'updateDataModel',
    value: function updateDataModel(props) {
      var data = props.data;
      var getData = props.getData,
          getLabel = props.getLabel,
          getSeriesID = props.getSeriesID,
          getPrimary = props.getPrimary,
          getSecondary = props.getSecondary,
          getR = props.getR;

      // Normalize getters

      getData = _Utils2.default.normalizePathGetter(getData);
      getLabel = _Utils2.default.normalizePathGetter(getLabel);
      getSeriesID = _Utils2.default.normalizePathGetter(getSeriesID);
      getPrimary = _Utils2.default.normalizePathGetter(getPrimary);
      getSecondary = _Utils2.default.normalizePathGetter(getSecondary);
      getR = _Utils2.default.normalizePathGetter(getR);

      // First access the data, and provide it to the context
      var materializedData = data.map(function (s, seriesIndex) {
        var seriesID = getSeriesID(s, seriesIndex);
        var seriesLabel = getLabel(s, seriesIndex);
        var series = {
          row: s,
          index: seriesIndex,
          id: seriesID,
          label: seriesLabel,
          data: getData(s, seriesIndex).map(function (d, index) {
            return {
              row: s,
              seriesIndex: seriesIndex,
              seriesID: seriesID,
              seriesLabel: seriesLabel,
              index: index,
              datum: d,
              primary: getPrimary(d, index),
              secondary: getSecondary(d, index),
              r: getR(d, index)
            };
          })
        };
        return series;
      });

      // Provide the materializedData to the chart instance
      this.props.dispatch(function (state) {
        return _extends({}, state, {
          materializedData: materializedData
        });
      }, {
        type: 'materializedData'
      });
    }
  }, {
    key: 'measure',
    value: function measure(prevProps) {
      var _this4 = this;

      if (prevProps && (this.props.offset.left !== prevProps.offset.left || this.props.offset.top !== prevProps.offset.top)) {
        this.props.dispatch(function (state) {
          return _extends({}, state, {
            offset: {
              left: _this4.el.offsetLeft,
              top: _this4.el.offsetTop
            }
          });
        }, {
          type: 'offset'
        });
      }
    }
  }, {
    key: 'render',
    value: function render() {
      var _this5 = this;

      var _props = this.props,
          style = _props.style,
          width = _props.width,
          height = _props.height,
          gridX = _props.gridX,
          gridY = _props.gridY,
          children = _props.children;


      var allChildren = _react2.default.Children.toArray(children);
      var svgChildren = allChildren.filter(function (d) {
        return !d.type.isHTML;
      });
      var htmlChildren = allChildren.filter(function (d) {
        return d.type.isHTML;
      });

      return _react2.default.createElement(
        'div',
        {
          className: 'Chart',
          style: {
            height: '0',
            width: '0'
          }
        },
        _react2.default.createElement(
          _reactMove.Animate,
          {
            data: {
              gridX: gridX,
              gridY: gridY
            }
          },
          function (_ref) {
            var gridX = _ref.gridX,
                gridY = _ref.gridY;
            return _react2.default.createElement(
              'svg',
              {
                ref: function ref(el) {
                  _this5.el = el;
                },
                style: _extends({
                  width: width,
                  height: height
                }, style)
              },
              _react2.default.createElement(
                'g',
                {
                  ref: function ref(el) {
                    _this5.el = el;
                  },
                  transform: 'translate(' + (gridX || 0) + ', ' + (gridY || 0) + ')',
                  onMouseEnter: function onMouseEnter(e) {
                    e.persist();
                    _this5.onMouseMove(e);
                  },
                  onMouseMove: function onMouseMove(e) {
                    e.persist();
                    _this5.onMouseMove(e);
                  },
                  onMouseLeave: _this5.onMouseLeave,
                  onMouseDown: _this5.onMouseDown,
                  onMouseUp: _this5.onMouseUp
                },
                _react2.default.createElement(_Rectangle2.default
                // This is to ensure the cursor always has something to hit
                , { x1: -gridX,
                  x2: width - gridX,
                  y1: -gridY,
                  y2: height - gridY,
                  style: {
                    opacity: 0
                  }
                }),
                svgChildren,
                _react2.default.createElement(_Voronoi2.default, null)
              )
            );
          }
        ),
        htmlChildren
      );
    }
  }, {
    key: 'onMouseMove',
    value: function onMouseMove(e) {
      var _this6 = this;

      var clientX = e.clientX,
          clientY = e.clientY;

      this.dims = this.el.getBoundingClientRect();
      var _props2 = this.props,
          gridX = _props2.gridX,
          gridY = _props2.gridY,
          dispatch = _props2.dispatch;


      dispatch(function (state) {
        return _extends({}, state, {
          cursor: _extends({}, state.cursor, {
            active: true,
            x: clientX - _this6.dims.left - gridX,
            y: clientY - _this6.dims.top - gridY,
            dragging: state.cursor && state.cursor.down
          })
        });
      }, {
        type: 'cursor'
      });
    }
  }, {
    key: 'onMouseLeave',
    value: function onMouseLeave() {
      this.props.dispatch(function (state) {
        return _extends({}, state, {
          cursor: _extends({}, state.cursor, {
            active: false
          }),
          hovered: _extends({}, state.hovered, {
            active: false
          })
        });
      }, {
        type: 'cursor_hovered'
      });
    }
  }, {
    key: 'onMouseDown',
    value: function onMouseDown() {
      var dispatch = this.props.dispatch;


      dispatch(function (state) {
        return _extends({}, state, {
          cursor: _extends({}, state.cursor, {
            sourceX: state.cursor.x,
            sourceY: state.cursor.y,
            down: true
          })
        });
      }, {
        type: 'cursor'
      });
    }
  }, {
    key: 'onMouseUp',
    value: function onMouseUp() {
      var dispatch = this.props.dispatch;

      dispatch(function (state) {
        return _extends({}, state, {
          cursor: _extends({}, state.cursor, {
            down: false,
            dragging: false,
            released: {
              x: state.cursor.x,
              y: state.cursor.y
            }
          })
        });
      }, {
        type: 'cursor'
      });
    }
  }]);

  return Chart;
}(_react.PureComponent);

Chart.defaultProps = {
  getData: function getData(d) {
    return d;
  },
  getLabel: function getLabel(d, i) {
    return 'Series ' + (i + 1);
  },
  getSeriesID: function getSeriesID(d, i) {
    return i;
  },
  getPrimary: function getPrimary(d) {
    return Array.isArray(d) ? d[0] : d.x;
  },
  getSecondary: function getSecondary(d) {
    return Array.isArray(d) ? d[1] : d.y;
  },
  getR: function getR(d) {
    return Array.isArray(d) ? d[0] : d.r;
  },
  decorate: function decorate(d) {
    return {};
  },
  interaction: 'closestPoint'
};


var ReactChart = (0, _reactState.Connect)(function () {
  var selectors = {
    primaryAxis: _Selectors2.default.primaryAxis(),
    gridX: _Selectors2.default.gridX(),
    gridY: _Selectors2.default.gridY(),
    offset: _Selectors2.default.offset()
  };
  return function (state) {
    return {
      data: state.data,
      width: state.width,
      height: state.height,
      gridX: selectors.gridX(state),
      gridY: selectors.gridY(state),
      active: state.active,
      offset: selectors.offset(state),
      selected: state.selected
    };
  };
}, {
  filter: function filter(oldState, newState, meta) {
    return meta.type !== 'cursor';
  }
})(Chart);

exports.default = (0, _HyperResponsive2.default)((0, _reactState.Provider)(ReactChart));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21wb25lbnRzL0NoYXJ0LmpzIl0sIm5hbWVzIjpbIkNoYXJ0IiwidXBkYXRlRGF0YU1vZGVsIiwiYmluZCIsIm1lYXN1cmUiLCJvbk1vdXNlTW92ZSIsInRocm90dGxlIiwib25Nb3VzZUxlYXZlIiwib25Nb3VzZURvd24iLCJvbk1vdXNlVXAiLCJwcm9wcyIsImRpc3BhdGNoIiwic3RhdGUiLCJpbnRlcmFjdGlvbiIsInR5cGUiLCJjb21wb25lbnREaWRVcGRhdGUiLCJuZXh0UHJvcHMiLCJkYXRhIiwid2lkdGgiLCJoZWlnaHQiLCJnZXREYXRhIiwiZ2V0U2VyaWVzSUQiLCJnZXRMYWJlbCIsImdldFByaW1hcnkiLCJnZXRTZWNvbmRhcnkiLCJnZXRSIiwic3R5bGUiLCJncmlkWCIsImdyaWRZIiwiY2hpbGRyZW4iLCJwcmV2UHJvcHMiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJub3JtYWxpemVQYXRoR2V0dGVyIiwibWF0ZXJpYWxpemVkRGF0YSIsIm1hcCIsInMiLCJzZXJpZXNJbmRleCIsInNlcmllc0lEIiwic2VyaWVzTGFiZWwiLCJzZXJpZXMiLCJyb3ciLCJpbmRleCIsImlkIiwibGFiZWwiLCJkIiwiZGF0dW0iLCJwcmltYXJ5Iiwic2Vjb25kYXJ5IiwiciIsIm9mZnNldCIsImxlZnQiLCJ0b3AiLCJlbCIsIm9mZnNldExlZnQiLCJvZmZzZXRUb3AiLCJhbGxDaGlsZHJlbiIsIkNoaWxkcmVuIiwidG9BcnJheSIsInN2Z0NoaWxkcmVuIiwiZmlsdGVyIiwiaXNIVE1MIiwiaHRtbENoaWxkcmVuIiwiZSIsInBlcnNpc3QiLCJvcGFjaXR5IiwiY2xpZW50WCIsImNsaWVudFkiLCJkaW1zIiwiZ2V0Qm91bmRpbmdDbGllbnRSZWN0IiwiY3Vyc29yIiwiYWN0aXZlIiwieCIsInkiLCJkcmFnZ2luZyIsImRvd24iLCJob3ZlcmVkIiwic291cmNlWCIsInNvdXJjZVkiLCJyZWxlYXNlZCIsImRlZmF1bHRQcm9wcyIsImkiLCJBcnJheSIsImlzQXJyYXkiLCJkZWNvcmF0ZSIsIlJlYWN0Q2hhcnQiLCJzZWxlY3RvcnMiLCJwcmltYXJ5QXhpcyIsInNlbGVjdGVkIiwib2xkU3RhdGUiLCJuZXdTdGF0ZSIsIm1ldGEiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOztBQUNBOztBQUVBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOzs7O0FBQ0E7Ozs7Ozs7Ozs7O0FBTkE7OztJQVFNQSxLOzs7QUFXSixtQkFBZTtBQUFBOztBQUFBOztBQUViLFVBQUtDLGVBQUwsR0FBdUIsTUFBS0EsZUFBTCxDQUFxQkMsSUFBckIsT0FBdkI7QUFDQSxVQUFLQyxPQUFMLEdBQWUsTUFBS0EsT0FBTCxDQUFhRCxJQUFiLE9BQWY7QUFDQSxVQUFLRSxXQUFMLEdBQW1CLGdCQUFNQyxRQUFOLENBQWUsTUFBS0QsV0FBTCxDQUFpQkYsSUFBakIsT0FBZixFQUE0QyxFQUE1QyxDQUFuQjtBQUNBLFVBQUtJLFlBQUwsR0FBb0IsTUFBS0EsWUFBTCxDQUFrQkosSUFBbEIsT0FBcEI7QUFDQSxVQUFLSyxXQUFMLEdBQW1CLE1BQUtBLFdBQUwsQ0FBaUJMLElBQWpCLE9BQW5CO0FBQ0EsVUFBS00sU0FBTCxHQUFpQixNQUFLQSxTQUFMLENBQWVOLElBQWYsT0FBakI7QUFQYTtBQVFkOzs7O3dDQUNvQjtBQUFBOztBQUNuQixXQUFLTyxLQUFMLENBQVdDLFFBQVgsQ0FDRTtBQUFBLDRCQUNLQyxLQURMO0FBRUVDLHVCQUFhLE9BQUtILEtBQUwsQ0FBV0c7QUFGMUI7QUFBQSxPQURGLEVBS0U7QUFDRUMsY0FBTTtBQURSLE9BTEY7QUFTQSxXQUFLWixlQUFMLENBQXFCLEtBQUtRLEtBQTFCO0FBQ0EsV0FBS0ssa0JBQUwsQ0FBd0IsS0FBS0wsS0FBN0I7QUFDRDs7OzhDQUMwQk0sUyxFQUFXO0FBQ3BDO0FBQ0EsVUFBSUEsVUFBVUgsV0FBVixLQUEwQixLQUFLSCxLQUFMLENBQVdHLFdBQXpDLEVBQXNEO0FBQ3BELGFBQUtILEtBQUwsQ0FBV0Ms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QUFPTHJCLGNBQVFvQyxVQUFVcEMsTUFBVixDQUFpQnJDLEtBQWpCLENBUEg7QUFRTDJFLGdCQUFVM0UsTUFBTTJFO0FBUlgsS0FBUDtBQVVELEdBWEQ7QUFZRCxDQXBCZ0IsRUFxQmpCO0FBQ0U1QixVQUFRLGdCQUFDNkIsUUFBRCxFQUFXQyxRQUFYLEVBQXFCQyxJQUFyQjtBQUFBLFdBQThCQSxLQUFLNUUsSUFBTCxLQUFjLFFBQTVDO0FBQUE7QUFEVixDQXJCaUIsRUF3QmpCYixLQXhCaUIsQ0FBbkI7O2tCQTBCZSwrQkFBZ0IsMEJBQVNtRixVQUFULENBQWhCLEMiLCJmaWxlIjoiQ2hhcnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgUHVyZUNvbXBvbmVudCB9IGZyb20gJ3JlYWN0J1xuaW1wb3J0IHsgQW5pbWF0ZSB9IGZyb20gJ3JlYWN0LW1vdmUnXG5pbXBvcnQgeyBQcm92aWRlciwgQ29ubmVjdCB9IGZyb20gJ3JlYWN0LXN0YXRlJ1xuLy9cbmltcG9ydCBTZWxlY3RvcnMgZnJvbSAnLi4vdXRpbHMvU2VsZWN0b3JzJ1xuaW1wb3J0IEh5cGVyUmVzcG9uc2l2ZSBmcm9tICcuLi91dGlscy9IeXBlclJlc3BvbnNpdmUnXG5pbXBvcnQgVXRpbHMgZnJvbSAnLi4vdXRpbHMvVXRpbHMnXG5cbmltcG9ydCBSZWN0YW5nbGUgZnJvbSAnLi4vcHJpbWl0aXZlcy9SZWN0YW5nbGUnXG5pbXBvcnQgVm9yb25vaSBmcm9tICcuLi9jb21wb25lbnRzL1Zvcm9ub2knXG5cbmNsYXNzIENoYXJ0IGV4dGVuZHMgUHVyZUNvbXBvbmVudCB7XG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgZ2V0RGF0YTogZCA9PiBkLFxuICAgIGdldExhYmVsOiAoZCwgaSkgPT4gJ1NlcmllcyAnICsgKGkgKyAxKSxcbiAgICBnZXRTZXJpZXNJRDogKGQsIGkpID0+IGksXG4gICAgZ2V0UHJpbWFyeTogZCA9PiAoQXJyYXkuaXNBcnJheShkKSA/IGRbMF0gOiBkLngpLFxuICAgIGdldFNlY29uZGFyeTogZCA9PiAoQXJyYXkuaXNBcnJheShkKSA/IGRbMV0gOiBkLnkpLFxuICAgIGdldFI6IGQgPT4gKEFycmF5LmlzQXJyYXkoZCkgPyBkWzBdIDogZC5yKSxcbiAgICBkZWNvcmF0ZTogZCA9PiAoe30pLFxuICAgIGludGVyYWN0aW9uOiAnY2xvc2VzdFBvaW50JyxcbiAgfVxuICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgc3VwZXIoKVxuICAgIHRoaXMudXBkYXRlRGF0YU1vZGVsID0gdGhpcy51cGRhdGVEYXRhTW9kZWwuYmluZCh0aGlzKVxuICAgIHRoaXMubWVhc3VyZSA9IHRoaXMubWVhc3VyZS5iaW5kKHRoaXMpXG4gICAgdGhpcy5vbk1vdXNlTW92ZSA9IFV0aWxzLnRocm90dGxlKHRoaXMub25Nb3VzZU1vdmUuYmluZCh0aGlzKSwgMTYpXG4gICAgdGhpcy5vbk1vdXNlTGVhdmUgPSB0aGlzLm9uTW91c2VMZWF2ZS5iaW5kKHRoaXMpXG4gICAgdGhpcy5vbk1vdXNlRG93biA9IHRoaXMub25Nb3VzZURvd24uYmluZCh0aGlzKVxuICAgIHRoaXMub25Nb3VzZVVwID0gdGhpcy5vbk1vdXNlVXAuYmluZCh0aGlzKVxuICB9XG4gIGNvbXBvbmVudERpZE1vdW50ICgpIHtcbiAgICB0aGlzLnByb3BzLmRpc3BhdGNoKFxuICAgICAgc3RhdGUgPT4gKHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGludGVyYWN0aW9uOiB0aGlzLnByb3BzLmludGVyYWN0aW9uLFxuICAgICAgfSksXG4gICAgICB7XG4gICAgICAgIHR5cGU6ICdpbnRlcmFjdGlvbicsXG4gICAgICB9XG4gICAgKVxuICAgIHRoaXMudXBkYXRlRGF0YU1vZGVsKHRoaXMucHJvcHMpXG4gICAgdGhpcy5jb21wb25lbnREaWRVcGRhdGUodGhpcy5wcm9wcylcbiAgfVxuICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIChuZXh0UHJvcHMpIHtcbiAgICAvLyBJZiBhbnl0aGluZyByZWxhdGVkIHRvIHRoZSBkYXRhIG1vZGVsIGNoYW5nZXMsIHVwZGF0ZSBpdFxuICAgIGlmIChuZXh0UHJvcHMuaW50ZXJhY3Rpb24gIT09IHRoaXMucHJvcHMuaW50ZXJhY3Rpb24pIHtcbiAgICAgIHRoaXMucHJvcHMuZGlzcGF0Y2goXG4gICAgICAgIHN0YXRlID0+ICh7XG4gICAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgICAgaW50ZXJhY3Rpb246IG5leHRQcm9wcy5pbnRlcmFjdGlvbixcbiAgICAgICAgfSksXG4gICAgICAgIHtcbiAgICAgICAgICB0eXBlOiAnaW50ZXJhY3Rpb24nLFxuICAgICAgICB9XG4gICAgICApXG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgbmV4dFByb3BzLmRhdGEgIT09IHRoaXMucHJvcHMuZGF0YSB8fFxuICAgICAgbmV4dFByb3BzLndpZHRoICE9PSB0aGlzLnByb3BzLndpZHRoIHx8XG4gICAgICBuZXh0UHJvcHMuaGVpZ2h0ICE9PSB0aGlzLnByb3BzLmhlaWdodCB8fFxuICAgICAgbmV4dFByb3BzLmdldERhdGEgIT09IHRoaXMucHJvcHMuZ2V0RGF0YSB8fFxuICAgICAgbmV4dFByb3BzLmdldFNlcmllc0lEICE9PSB0aGlzLnByb3BzLmdldFNlcmllc0lEIHx8XG4gICAgICBuZXh0UHJvcHMuZ2V0TGFiZWwgIT09IHRoaXMucHJvcHMuZ2V0TGFiZWwgfHxcbiAgICAgIG5leHRQcm9wcy5nZXRQcmltYXJ5ICE9PSB0aGlzLnByb3BzLmdldFByaW1hcnkgfHxcbiAgICAgIG5leHRQcm9wcy5nZXRTZWNvbmRhcnkgIT09IHRoaXMucHJvcHMuZ2V0U2Vjb25kYXJ5IHx8XG4gICAgICBuZXh0UHJvcHMuZ2V0UiAhPT0gdGhpcy5wcm9wcy5nZXRSXG4gICAgKSB7XG4gICAgICB0aGlzLnVwZGF0ZURhdGFNb2RlbChuZXh0UHJvcHMpXG4gICAgfVxuICB9XG4gIHNob3VsZENvbXBvbmVudFVwZGF0ZSAobmV4dFByb3BzKSB7XG4gICAgaWYgKFxuICAgICAgbmV4dFByb3BzLnN0eWxlICE9PSB0aGlzLnByb3BzLnN0eWxlIHx8XG4gICAgICBuZXh0UHJvcHMud2lkdGggIT09IHRoaXMucHJvcHMud2lkdGggfHxcbiAgICAgIG5leHRQcm9wcy5oZWlnaHQgIT09IHRoaXMucHJvcHMuaGVpZ2h0IHx8XG4gICAgICBuZXh0UHJvcHMuZ3JpZFggIT09IHRoaXMucHJvcHMuZ3JpZFggfHxcbiAgICAgIG5leHRQcm9wcy5ncmlkWSAhPT0gdGhpcy5wcm9wcy5ncmlkWSB8fFxuICAgICAgbmV4dFByb3BzLmNoaWxkcmVuICE9PSB0aGlzLnByb3BzLmNoaWxkcmVuXG4gICAgKSB7XG4gICAgICByZXR1cm4gdHJ1ZVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuICBjb21wb25lbnREaWRVcGRhdGUgKHByZXZQcm9wcykge1xuICAgIFV0aWxzLnJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB0aGlzLm1lYXN1cmUocHJldlByb3BzKSlcbiAgfVxuICB1cGRhdGVEYXRhTW9kZWwgKHByb3BzKSB7XG4gICAgY29uc3QgeyBkYXRhIH0gPSBwcm9wc1xuICAgIGxldCB7XG4gICAgICBnZXREYXRhLFxuICAgICAgZ2V0TGFiZWwsXG4gICAgICBnZXRTZXJpZXNJRCxcbiAgICAgIGdldFByaW1hcnksXG4gICAgICBnZXRTZWNvbmRhcnksXG4gICAgICBnZXRSLFxuICAgIH0gPSBwcm9wc1xuXG4gICAgLy8gTm9ybWFsaXplIGdldHRlcnNcbiAgICBnZXREYXRhID0gVXRpbHMubm9ybWFsaXplUGF0aEdldHRlcihnZXREYXRhKVxuICAgIGdldExhYmVsID0gVXRpbHMubm9ybWFsaXplUGF0aEdldHRlcihnZXRMYWJlbClcbiAgICBnZXRTZXJpZXNJRCA9IFV0aWxzLm5vcm1hbGl6ZVBhdGhHZXR0ZXIoZ2V0U2VyaWVzSUQpXG4gICAgZ2V0UHJpbWFyeSA9IFV0aWxzLm5vcm1hbGl6ZVBhdGhHZXR0ZXIoZ2V0UHJpbWFyeSlcbiAgICBnZXRTZWNvbmRhcnkgPSBVdGlscy5ub3JtYWxpemVQYXRoR2V0dGVyKGdldFNlY29uZGFyeSlcbiAgICBnZXRSID0gVXRpbHMubm9ybWFsaXplUGF0aEdldHRlcihnZXRSKVxuXG4gICAgLy8gRmlyc3QgYWNjZXNzIHRoZSBkYXRhLCBhbmQgcHJvdmlkZSBpdCB0byB0aGUgY29udGV4dFxuICAgIGxldCBtYXRlcmlhbGl6ZWREYXRhID0gZGF0YS5tYXAoKHMsIHNlcmllc0luZGV4KSA9PiB7XG4gICAgICBjb25zdCBzZXJpZXNJRCA9IGdldFNlcmllc0lEKHMsIHNlcmllc0luZGV4KVxuICAgICAgY29uc3Qgc2VyaWVzTGFiZWwgPSBnZXRMYWJlbChzLCBzZXJpZXNJbmRleClcbiAgICAgIGNvbnN0IHNlcmllcyA9IHtcbiAgICAgICAgcm93OiBzLFxuICAgICAgICBpbmRleDogc2VyaWVzSW5kZXgsXG4gICAgICAgIGlkOiBzZXJpZXNJRCxcbiAgICAgICAgbGFiZWw6IHNlcmllc0xhYmVsLFxuICAgICAgICBkYXRhOiBnZXREYXRhKHMsIHNlcmllc0luZGV4KS5tYXAoKGQsIGluZGV4KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHJvdzogcyxcbiAgICAgICAgICAgIHNlcmllc0luZGV4LFxuICAgICAgICAgICAgc2VyaWVzSUQsXG4gICAgICAgICAgICBzZXJpZXNMYWJlbCxcbiAgICAgICAgICAgIGluZGV4LFxuICAgICAgICAgICAgZGF0dW06IGQsXG4gICAgICAgICAgICBwcmltYXJ5OiBnZXRQcmltYXJ5KGQsIGluZGV4KSxcbiAgICAgICAgICAgIHNlY29uZGFyeTogZ2V0U2Vjb25kYXJ5KGQsIGluZGV4KSxcbiAgICAgICAgICAgIHI6IGdldFIoZCwgaW5kZXgpLFxuICAgICAgICAgIH1cbiAgICAgICAgfSksXG4gICAgICB9XG4gICAgICByZXR1cm4gc2VyaWVzXG4gICAgfSlcblxuICAgIC8vIFByb3ZpZGUgdGhlIG1hdGVyaWFsaXplZERhdGEgdG8gdGhlIGNoYXJ0IGluc3RhbmNlXG4gICAgdGhpcy5wcm9wcy5kaXNwYXRjaChcbiAgICAgIHN0YXRlID0+ICh7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBtYXRlcmlhbGl6ZWREYXRhLFxuICAgICAgfSksXG4gICAgICB7XG4gICAgICAgIHR5cGU6ICdtYXRlcmlhbGl6ZWREYXRhJyxcbiAgICAgIH1cbiAgICApXG4gIH1cbiAgbWVhc3VyZSAocHJldlByb3BzKSB7XG4gICAgaWYgKFxuICAgICAgcHJldlByb3BzICYmXG4gICAgICAodGhpcy5wcm9wcy5vZmZzZXQubGVmdCAhPT0gcHJldlByb3BzLm9mZnNldC5sZWZ0IHx8XG4gICAgICAgIHRoaXMucHJvcHMub2Zmc2V0LnRvcCAhPT0gcHJldlByb3BzLm9mZnNldC50b3ApXG4gICAgKSB7XG4gICAgICB0aGlzLnByb3BzLmRpc3BhdGNoKFxuICAgICAgICBzdGF0ZSA9PiAoe1xuICAgICAgICAgIC4uLnN0YXRlLFxuICAgICAgICAgIG9mZnNldDoge1xuICAgICAgICAgICAgbGVmdDogdGhpcy5lbC5vZmZzZXRMZWZ0LFxuICAgICAgICAgICAgdG9wOiB0aGlzLmVsLm9mZnNldFRvcCxcbiAgICAgICAgICB9LFxuICAgICAgICB9KSxcbiAgICAgICAge1xuICAgICAgICAgIHR5cGU6ICdvZmZzZXQnLFxuICAgICAgICB9XG4gICAgICApXG4gICAgfVxuICB9XG4gIHJlbmRlciAoKSB7XG4gICAgY29uc3QgeyBzdHlsZSwgd2lkdGgsIGhlaWdodCwgZ3JpZFgsIGdyaWRZLCBjaGlsZHJlbiB9ID0gdGhpcy5wcm9wc1xuXG4gICAgY29uc3QgYWxsQ2hpbGRyZW4gPSBSZWFjdC5DaGlsZHJlbi50b0FycmF5KGNoaWxkcmVuKVxuICAgIGNvbnN0IHN2Z0NoaWxkcmVuID0gYWxsQ2hpbGRyZW4uZmlsdGVyKGQgPT4gIWQudHlwZS5pc0hUTUwpXG4gICAgY29uc3QgaHRtbENoaWxkcmVuID0gYWxsQ2hpbGRyZW4uZmlsdGVyKGQgPT4gZC50eXBlLmlzSFRNTClcblxuICAgIHJldHVybiAoXG4gICAgICA8ZGl2XG4gICAgICAgIGNsYXNzTmFtZT0nQ2hhcnQnXG4gICAgICAgIHN0eWxlPXt7XG4gICAgICAgICAgaGVpZ2h0OiAnMCcsXG4gICAgICAgICAgd2lkdGg6ICcwJyxcbiAgICAgICAgfX1cbiAgICAgID5cbiAgICAgICAgPEFuaW1hdGVcbiAgICAgICAgICBkYXRhPXt7XG4gICAgICAgICAgICBncmlkWCxcbiAgICAgICAgICAgIGdyaWRZLFxuICAgICAgICAgIH19XG4gICAgICAgID5cbiAgICAgICAgICB7KHsgZ3JpZFgsIGdyaWRZIH0pID0+XG4gICAgICAgICAgICAoPHN2Z1xuICAgICAgICAgICAgICByZWY9e2VsID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmVsID0gZWxcbiAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgc3R5bGU9e3tcbiAgICAgICAgICAgICAgICB3aWR0aDogd2lkdGgsXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiBoZWlnaHQsXG4gICAgICAgICAgICAgICAgLi4uc3R5bGUsXG4gICAgICAgICAgICAgIH19XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgIDxnXG4gICAgICAgICAgICAgICAgcmVmPXtlbCA9PiB7XG4gICAgICAgICAgICAgICAgICB0aGlzLmVsID0gZWxcbiAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgIHRyYW5zZm9ybT17YHRyYW5zbGF0ZSgke2dyaWRYIHx8IDB9LCAke2dyaWRZIHx8IDB9KWB9XG4gICAgICAgICAgICAgICAgb25Nb3VzZUVudGVyPXtlID0+IHtcbiAgICAgICAgICAgICAgICAgIGUucGVyc2lzdCgpXG4gICAgICAgICAgICAgICAgICB0aGlzLm9uTW91c2VNb3ZlKGUpXG4gICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgICBvbk1vdXNlTW92ZT17ZSA9PiB7XG4gICAgICAgICAgICAgICAgICBlLnBlcnNpc3QoKVxuICAgICAgICAgICAgICAgICAgdGhpcy5vbk1vdXNlTW92ZShlKVxuICAgICAgICAgICAgICAgIH19XG4gICAgICAgICAgICAgICAgb25Nb3VzZUxlYXZlPXt0aGlzLm9uTW91c2VMZWF2ZX1cbiAgICAgICAgICAgICAgICBvbk1vdXNlRG93bj17dGhpcy5vbk1vdXNlRG93bn1cbiAgICAgICAgICAgICAgICBvbk1vdXNlVXA9e3RoaXMub25Nb3VzZVVwfVxuICAgICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgPFJlY3RhbmdsZVxuICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyB0byBlbnN1cmUgdGhlIGN1cnNvciBhbHdheXMgaGFzIHNvbWV0aGluZyB0byBoaXRcbiAgICAgICAgICAgICAgICAgIHgxPXstZ3JpZFh9XG4gICAgICAgICAgICAgICAgICB4Mj17d2lkdGggLSBncmlkWH1cbiAgICAgICAgICAgICAgICAgIHkxPXstZ3JpZFl9XG4gICAgICAgICAgICAgICAgICB5Mj17aGVpZ2h0IC0gZ3JpZFl9XG4gICAgICAgICAgICAgICAgICBzdHlsZT17e1xuICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiAwLFxuICAgICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICAgIHtzdmdDaGlsZHJlbn1cbiAgICAgICAgICAgICAgICA8Vm9yb25vaSAvPlxuICAgICAgICAgICAgICA8L2c+XG4gICAgICAgICAgICA8L3N2Zz4pfVxuICAgICAgICA8L0FuaW1hdGU+XG4gICAgICAgIHtodG1sQ2hpbGRyZW59XG4gICAgICA8L2Rpdj5cbiAgICApXG4gIH1cbiAgb25Nb3VzZU1vdmUgKGUpIHtcbiAgICBjb25zdCB7IGNsaWVudFgsIGNsaWVudFkgfSA9IGVcbiAgICB0aGlzLmRpbXMgPSB0aGlzLmVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG4gICAgY29uc3QgeyBncmlkWCwgZ3JpZFksIGRpc3BhdGNoIH0gPSB0aGlzLnByb3BzXG5cbiAgICBkaXNwYXRjaChcbiAgICAgIHN0YXRlID0+ICh7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBjdXJzb3I6IHtcbiAgICAgICAgICAuLi5zdGF0ZS5jdXJzb3IsXG4gICAgICAgICAgYWN0aXZlOiB0cnVlLFxuICAgICAgICAgIHg6IGNsaWVudFggLSB0aGlzLmRpbXMubGVmdCAtIGdyaWRYLFxuICAgICAgICAgIHk6IGNsaWVudFkgLSB0aGlzLmRpbXMudG9wIC0gZ3JpZFksXG4gICAgICAgICAgZHJhZ2dpbmc6IHN0YXRlLmN1cnNvciAmJiBzdGF0ZS5jdXJzb3IuZG93bixcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgICAge1xuICAgICAgICB0eXBlOiAnY3Vyc29yJyxcbiAgICAgIH1cbiAgICApXG4gIH1cbiAgb25Nb3VzZUxlYXZlICgpIHtcbiAgICB0aGlzLnByb3BzLmRpc3BhdGNoKFxuICAgICAgc3RhdGUgPT4gKHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGN1cnNvcjoge1xuICAgICAgICAgIC4uLnN0YXRlLmN1cnNvcixcbiAgICAgICAgICBhY3RpdmU6IGZhbHNlLFxuICAgICAgICB9LFxuICAgICAgICBob3ZlcmVkOiB7XG4gICAgICAgICAgLi4uc3RhdGUuaG92ZXJlZCxcbiAgICAgICAgICBhY3RpdmU6IGZhbHNlLFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgICB7XG4gICAgICAgIHR5cGU6ICdjdXJzb3JfaG92ZXJlZCcsXG4gICAgICB9XG4gICAgKVxuICB9XG4gIG9uTW91c2VEb3duICgpIHtcbiAgICBjb25zdCB7IGRpc3BhdGNoIH0gPSB0aGlzLnByb3BzXG5cbiAgICBkaXNwYXRjaChcbiAgICAgIHN0YXRlID0+ICh7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBjdXJzb3I6IHtcbiAgICAgICAgICAuLi5zdGF0ZS5jdXJzb3IsXG4gICAgICAgICAgc291cmNlWDogc3RhdGUuY3Vyc29yLngsXG4gICAgICAgICAgc291cmNlWTogc3RhdGUuY3Vyc29yLnksXG4gICAgICAgICAgZG93bjogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0pLFxuICAgICAge1xuICAgICAgICB0eXBlOiAnY3Vyc29yJyxcbiAgICAgIH1cbiAgICApXG4gIH1cbiAgb25Nb3VzZVVwICgpIHtcbiAgICBjb25zdCB7IGRpc3BhdGNoIH0gPSB0aGlzLnByb3BzXG4gICAgZGlzcGF0Y2goXG4gICAgICBzdGF0ZSA9PiAoe1xuICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgY3Vyc29yOiB7XG4gICAgICAgICAgLi4uc3RhdGUuY3Vyc29yLFxuICAgICAgICAgIGRvd246IGZhbHNlLFxuICAgICAgICAgIGRyYWdnaW5nOiBmYWxzZSxcbiAgICAgICAgICByZWxlYXNlZDoge1xuICAgICAgICAgICAgeDogc3RhdGUuY3Vyc29yLngsXG4gICAgICAgICAgICB5OiBzdGF0ZS5jdXJzb3IueSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgICB7XG4gICAgICAgIHR5cGU6ICdjdXJzb3InLFxuICAgICAgfVxuICAgIClcbiAgfVxufVxuXG5jb25zdCBSZWFjdENoYXJ0ID0gQ29ubmVjdChcbiAgKCkgPT4ge1xuICAgIGNvbnN0IHNlbGVjdG9ycyA9IHtcbiAgICAgIHByaW1hcnlBeGlzOiBTZWxlY3RvcnMucHJpbWFyeUF4aXMoKSxcbiAgICAgIGdyaWRYOiBTZWxlY3RvcnMuZ3JpZFgoKSxcbiAgICAgIGdyaWRZOiBTZWxlY3RvcnMuZ3JpZFkoKSxcbiAgICAgIG9mZnNldDogU2VsZWN0b3JzLm9mZnNldCgpLFxuICAgIH1cbiAgICByZXR1cm4gc3RhdGUgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgZGF0YTogc3RhdGUuZGF0YSxcbiAgICAgICAgd2lkdGg6IHN0YXRlLndpZHRoLFxuICAgICAgICBoZWlnaHQ6IHN0YXRlLmhlaWdodCxcbiAgICAgICAgZ3JpZFg6IHNlbGVjdG9ycy5ncmlkWChzdGF0ZSksXG4gICAgICAgIGdyaWRZOiBzZWxlY3RvcnMuZ3JpZFkoc3RhdGUpLFxuICAgICAgICBhY3RpdmU6IHN0YXRlLmFjdGl2ZSxcbiAgICAgICAgb2Zmc2V0OiBzZWxlY3RvcnMub2Zmc2V0KHN0YXRlKSxcbiAgICAgICAgc2VsZWN0ZWQ6IHN0YXRlLnNlbGVjdGVkLFxuICAgICAgfVxuICAgIH1cbiAgfSxcbiAge1xuICAgIGZpbHRlcjogKG9sZFN0YXRlLCBuZXdTdGF0ZSwgbWV0YSkgPT4gbWV0YS50eXBlICE9PSAnY3Vyc29yJyxcbiAgfVxuKShDaGFydClcblxuZXhwb3J0IGRlZmF1bHQgSHlwZXJSZXNwb25zaXZlKFByb3ZpZGVyKFJlYWN0Q2hhcnQpKVxuIl19